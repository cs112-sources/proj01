name: Autograding Tests
'on':
- push
- repository_dispatch
- workflow_dispatch
permissions:
  checks: write
  actions: read
  contents: read
jobs:
  run-autograding-tests:
    runs-on: ubuntu-latest
    container:
      image: calvincsinfrastructure/devcontainer-cs112-autograde:latest
    if: github.actor != 'github-classroom[bot]'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    - name: compile via make
      id: compile-make
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: compile
        setup-command: make
        command: test -f tester
        timeout: 4
        max-score: 0
    - name: step1
      id: step1
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: step1
        command: "./tester step1"
        timeout: 10
        max-score: 1
    - name: step2
      id: step2
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: step2
        command: "./tester step2"
        timeout: 10
        max-score: 1
    - name: step3
      id: step3
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: step3
        command: "./tester step3"
        timeout: 10
        max-score: 1
    - name: step4
      id: step4
      uses: classroom-resources/autograding-command-grader@v1
      with:
        test-name: step4
        command: "./tester step4"
        timeout: 10
        max-score: 1
    - name: Create Summary
      id: summary
      env:
        COMPILE_RESULT: ${{ steps.compile-make.outputs.result }}
        STEP1_RESULT: ${{ steps.step1.outputs.result }}
        STEP2_RESULT: ${{ steps.step2.outputs.result }}
        STEP3_RESULT: ${{ steps.step3.outputs.result }}
        STEP4_RESULT: ${{ steps.step4.outputs.result }}
      run: |
        echo "## Autograding Results" >> $GITHUB_STEP_SUMMARY
        echo "| Test | Status | Score |" >> $GITHUB_STEP_SUMMARY
        echo "|------|--------|-------|" >> $GITHUB_STEP_SUMMARY
        
        # POSIX-compliant function to process test results
        process_result() {
          test_name="$1"
          result="$2"
          icon="❌"
          status="FAILED"
          case "$result" in
            *✓*|success)
              icon="✅"
              status="PASSED"
              ;;
          esac
          score=$(echo "$result" | grep -o '[0-9]\+/[0-9]\+' || echo '0/1')
          echo "| $test_name | $icon $status | $score |" >> "$GITHUB_STEP_SUMMARY"
        }

        # Process each test (no arrays)
        process_result "compile via make" "$COMPILE_RESULT"
        process_result "step1" "$STEP1_RESULT"
        process_result "step2" "$STEP2_RESULT"
        process_result "step3" "$STEP3_RESULT"
        process_result "step4" "$STEP4_RESULT"

        echo "" >> $GITHUB_STEP_SUMMARY
        echo "---" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "╔════════════════════════════════════════╗" >> $GITHUB_STEP_SUMMARY
        echo "║            Test Results                ║" >> $GITHUB_STEP_SUMMARY
        echo "╠════════════════════════════════════════╣" >> $GITHUB_STEP_SUMMARY

        # ASCII results (no arrays, just repeat for each test)
        test_name="compile via make"
        result="$COMPILE_RESULT"
        case "$result" in
          *✓*|success)
            printf "║ %-30s [PASS] ║\n" "$test_name" >> "$GITHUB_STEP_SUMMARY"
            ;;
          *)
            printf "║ %-30s [FAIL] ║\n" "$test_name" >> "$GITHUB_STEP_SUMMARY"
            ;;
        esac

        test_name="step1"
        result="$STEP1_RESULT"
        case "$result" in
          *✓*|success)
            printf "║ %-30s [PASS] ║\n" "$test_name" >> "$GITHUB_STEP_SUMMARY"
            ;;
          *)
            printf "║ %-30s [FAIL] ║\n" "$test_name" >> "$GITHUB_STEP_SUMMARY"
            ;;
        esac

        test_name="step2"
        result="$STEP2_RESULT"
        case "$result" in
          *✓*|success)
            printf "║ %-30s [PASS] ║\n" "$test_name" >> "$GITHUB_STEP_SUMMARY"
            ;;
          *)
            printf "║ %-30s [FAIL] ║\n" "$test_name" >> "$GITHUB_STEP_SUMMARY"
            ;;
        esac

        test_name="step3"
        result="$STEP3_RESULT"
        case "$result" in
          *✓*|success)
            printf "║ %-30s [PASS] ║\n" "$test_name" >> "$GITHUB_STEP_SUMMARY"
            ;;
          *)
            printf "║ %-30s [FAIL] ║\n" "$test_name" >> "$GITHUB_STEP_SUMMARY"
            ;;
        esac

        test_name="step4"
        result="$STEP4_RESULT"
        case "$result" in
          *✓*|success)
            printf "║ %-30s [PASS] ║\n" "$test_name" >> "$GITHUB_STEP_SUMMARY"
            ;;
          *)
            printf "║ %-30s [FAIL] ║\n" "$test_name" >> "$GITHUB_STEP_SUMMARY"
            ;;
        esac
        
        echo "╚════════════════════════════════════════╝" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
